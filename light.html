<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ® 2026 å¹£åœˆå…‰æ˜ç‡ˆ | Crypto Beacon Light V8</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #FFD700;
            --primary-red: #D90429;
            --dark-bg: #1a0505;
            --neon-glow: 0 0 15px var(--primary-gold), 0 0 30px var(--primary-red);
        }
        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 50% 30%, #4a0000 0%, #1a0505 70%);
            color: var(--primary-gold);
            font-family: 'Noto Serif TC', 'Microsoft JhengHei', serif;
            text-align: center;
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .marquee-container {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid var(--primary-gold);
            width: 100%; height: 40px;
            display: flex; align-items: center;
            overflow: hidden; position: relative; z-index: 100;
        }
        .marquee-content {
            display: inline-block; white-space: nowrap;
            animation: scroll 80s linear infinite;
            color: #fff; font-size: 15px;
        }
        .marquee-item { margin-right: 50px; display: inline-flex; align-items: center; }
        .marquee-addr { color: var(--primary-gold); margin-right: 8px; font-family: monospace; background: #300; padding: 2px 6px; border-radius: 4px; border: 1px solid #500; }
        @keyframes scroll { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        .container { max-width: 500px; margin: 20px auto; padding: 0 20px 80px 20px; }
        h1 { font-size: 2.2rem; margin-bottom: 5px; text-shadow: 2px 2px 8px #000; margin-top: 20px; }
        .subtitle { color: #ffb3b3; margin-bottom: 20px; font-size: 1rem; line-height: 1.4; }

        .stats-board {
            display: flex; justify-content: space-between;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--primary-gold);
            border-radius: 12px;
            padding: 15px 5px; margin-bottom: 25px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .stat-item { display: flex; flex-direction: column; width: 32%; align-items: center; }
        .stat-label { font-size: 11px; color: #aaa; margin-bottom: 5px; white-space: nowrap; }
        .stat-value { font-size: 15px; font-weight: bold; color: var(--primary-gold); font-family: monospace; word-break: break-all; }
        #totalProfit { color: #00FF00; text-shadow: 0 0 5px rgba(0,255,0,0.5); }

        .dashboard-card {
            background: rgba(60, 10, 10, 0.9);
            border: 3px solid var(--primary-gold);
            border-radius: 15px;
            padding: 25px; margin-bottom: 25px;
            box-shadow: var(--neon-glow);
            position: relative;
        }

        /* ğŸ“œ è¦å‰‡æ¨£å¼ */
        .rules-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #886600;
            padding: 20px;
            text-align: left;
            margin-bottom: 25px;
        }
        .rule-item { margin-bottom: 15px; border-bottom: 1px dashed #443300; padding-bottom: 10px; }
        .rule-item:last-child { border-bottom: none; }
        .rule-title { color: var(--primary-gold); font-size: 16px; margin-bottom: 4px; display: block; }
        .rule-desc { color: #ddd; font-size: 14px; margin: 0; line-height: 1.5; }
        .en-text { display: block; color: #999; font-size: 12px; margin-top: 2px; font-family: sans-serif; font-style: italic; }

        .wish-paper { background: #fffce0; border: 2px solid #b71c1c; padding: 20px 15px; color: #b71c1c; border-radius: 5px; margin-bottom: 20px; position: relative; }
        .wish-input { width: 90%; border: none; border-bottom: 2px dashed #b71c1c; background: transparent; color: #b71c1c; font-size: 18px; padding: 8px; margin: 8px 0; text-align: center; outline: none; font-weight: bold; }
        
        .btn {
            background: linear-gradient(180deg, var(--primary-gold), #FFA500);
            color: #500000; border: none; padding: 15px 30px;
            font-size: 18px; font-weight: bold; border-radius: 50px;
            cursor: pointer; width: 100%; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: block; 
            white-space: pre-wrap; /* å…è¨±æŒ‰éˆ•å…§æ›è¡Œ */
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn:disabled { filter: grayscale(1); cursor: not-allowed; transform: none; opacity: 0.7; }
        .btn-danger { background: linear-gradient(180deg, #ff5252, #b71c1c); color: white; }

        .privacy-alert { font-size: 13px; color: #ffcccc; background: rgba(183, 28, 28, 0.6); padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ff5252; text-align: left; }
        .status-value { font-size: 18px; font-weight: bold; color: #00FF00; }
        .countdown { font-family: monospace; font-size: 20px; color: #FFA500; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin: 15px 0; }
        .hidden { display: none !important; }
        #loadingMsg { color: #FFA500; font-size: 18px; margin: 20px 0; display: none; }

        /* ğŸ”¥ é™¤éŒ¯å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 999;
            display: none; align-items: center; justify-content: center;
        }
        .error-modal {
            background: #2a0a0a; border: 2px solid #ff5252;
            padding: 20px; border-radius: 10px; width: 90%; max-width: 400px;
            text-align: left; box-shadow: 0 0 30px #ff0000;
        }
        .error-title { color: #ff5252; margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        .error-content {
            width: 100%; height: 150px; background: #000; color: #0f0;
            font-family: monospace; font-size: 12px; border: 1px solid #555;
            margin: 10px 0; padding: 10px; box-sizing: border-box; resize: none;
        }
        .modal-btn-group { display: flex; gap: 10px; }
        .btn-copy { background: #007bff; color: white; flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-close { background: #555; color: white; width: 80px; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="errorModal" class="modal-overlay">
        <div class="error-modal">
            <h3 class="error-title">âš ï¸ ç™¼ç”ŸéŒ¯èª¤ (Error) <button onclick="closeError()" style="background:none;border:none;color:#fff;font-size:20px;">&times;</button></h3>
            <p style="color:#ccc; font-size:13px; margin:0;">è«‹è¤‡è£½ä¸‹æ–¹å…§å®¹ä¸¦è²¼çµ¦å·¥ç¨‹å¸«ï¼š<br>Please copy the text below:</p>
            <textarea id="errorText" class="error-content" readonly></textarea>
            <div class="modal-btn-group">
                <button class="btn-copy" onclick="copyError()">ğŸ“‹ è¤‡è£½ (Copy)</button>
                <button class="btn-close" onclick="closeError()">Close</button>
            </div>
        </div>
    </div>

    <div class="marquee-container">
        <div class="marquee-content" id="marqueeText">
            âœ¨ ç³»çµ±å•Ÿå‹•ä¸­... System Initializing... âœ¨
        </div>
    </div>

    <div class="container">
        <h1>ğŸ® 2026 å¹£åœˆå…‰æ˜ç‡ˆ</h1>
        <div class="subtitle">
            è‡ªå‹•è³¼è²· Pancake V3 (0.05%) é–å€‰ç¥ˆç¦<br>
            <span class="en-text" style="color:#ffb3b3; font-style:normal;">Auto-buy Pancake V3 (0.05%) & Lock for Blessings</span>
        </div>

        <div class="stats-board">
            <div class="stat-item">
                <span class="stat-label">ğŸ”¥ ç´¯ç©é¦™æ²¹éŒ¢ (TVL)</span>
                <span class="stat-value" id="totalBNB">0.00 BNB</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ğŸ’° ç´¯ç©å·²ç™¼åˆ©æ½¤ (Yield)</span>
                <span class="stat-value" id="totalProfit">0.00 BNB</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ğŸ‘¥ ç´¯ç©ä¿¡å¾’ (Users)</span>
                <span class="stat-value" id="totalUsers">0</span>
            </div>
        </div>

        <div class="dashboard-card rules-card">
            <h3 style="margin-top:0; color:var(--primary-gold); text-align:center;">ğŸ“œ è¦å‰‡èˆ‡å¿ƒæ³•<br><span style="font-size:14px; color:#aaa;">Rules & Law of Attraction</span></h3>
            
            <div class="rule-item">
                <span class="rule-title">1. è²¡åº«ä¸Šé– (Locked for Wealth)</span>
                <p class="rule-desc">æ‚¨çš„ BNB å°‡è‡ªå‹•å…Œæ›ç‚º slisBNB ä¸¦é–å€‰ 365 å¤©ã€‚é€™æ˜¯å‘å®‡å®™ç™¼å‡ºçš„ã€Œå®ˆè²¡ã€è¨Šè™Ÿï¼Œè±¡å¾µè²¡åº«ç©©å›ºã€‚</p>
                <span class="en-text">Your BNB is swapped to slisBNB and locked for 365 days. This is a signal to the universe that you are holding for wealth.</span>
            </div>

            <div class="rule-item">
                <span class="rule-title">2. å¸å¼•åŠ›æ³•å‰‡ (The Law of Attraction)</span>
                <p class="rule-desc">è²¡å¯Œæµå‘è€å¿ƒä¹‹äººã€‚ç•¶æ‚¨è¨±ä¸‹é¡˜æœ›ä¸¦é–å®šè³‡ç”¢ï¼Œæ”¾ä¸‹çŸ­æœŸæ³¢å‹•çš„ç„¦æ…®ï¼Œæ‚¨æ­£åœ¨é¡¯åŒ–æœªä¾†çš„å¯Œè¶³ã€‚</p>
                <span class="en-text">Wealth flows to the patient. By making a wish and locking assets, letting go of short-term anxiety, you are manifesting future abundance.</span>
            </div>

            <div class="rule-item">
                <span class="rule-title">3. çœŸå¯¦æ”¶ç›Š (Real Yield)</span>
                <p class="rule-desc">åˆ©ç”¨ PancakeSwap V3 (0.05%) ç²å–å¸‚å ´æ”¶ç›Šã€‚æœŸæ»¿æ™‚ï¼Œæœ¬é‡‘åŠ åˆ©æ½¤å°‡å…¨æ•¸æ­¸é‚„ã€‚</p>
                <span class="en-text">Earn market yield via PancakeSwap V3. Principal plus profit will be returned upon maturity.</span>
            </div>

            <div class="rule-item" style="border-bottom:none;">
                <span class="rule-title" style="color:#ff5252;">4. ç ´è²¡æ¶ˆç½ (Early Exit Penalty)</span>
                <p class="rule-desc">è‹¥æœªæ»¿ä¸€å¹´ææ—©ç†„ç‡ˆï¼ˆé•ç´„ï¼‰ï¼Œå°‡æ‰£é™¤ 5% æœ¬é‡‘ä½œç‚ºé•ç´„é‡‘ï¼Œä¸”ä¸ç™¼æ”¾åˆ©æ½¤ã€‚</p>
                <span class="en-text">Early exit (breaking the vow) incurs a 5% fee on principal and forfeits all profits.</span>
            </div>
        </div>

        <div id="connectSection">
            <button id="connectBtn" class="btn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ…<br><span style="font-size:14px;">Connect Wallet</span></button>
            <p style="color:#aaa; font-size:13px; margin-top:10px;">è«‹ä½¿ç”¨ BSC ä¸»ç¶² â€¢ 0.1 ~ 1.0 BNB<br><span class="en-text">BSC Mainnet Only</span></p>
        </div>

        <div id="loadingMsg">â³ æ­£åœ¨è®€å–å€å¡Šéˆæ•¸æ“š...<br><span class="en-text">Loading Blockchain Data...</span></div>

        <div id="lightLampSection" class="hidden">
            <div class="dashboard-card">
                <h3 style="margin-top:0; color:var(--primary-gold);">ğŸ™ å¡«å¯«ç¥ˆç¦ç–æ–‡<br><span style="font-size:14px; color:#aaa;">Make Your Wishes</span></h3>
                <div class="privacy-alert">
                    <strong>âš ï¸ V8 æç¤º (Note)ï¼š</strong><br>
                    æœ¬é‡‘å°‡å…Œæ›ç‚º slisBNBã€‚é¦™æ²¹éŒ¢é™åˆ¶ï¼š<strong>0.1 ~ 1.0 BNB</strong>ã€‚<br>
                    <span class="en-text" style="color:#ffcccc;">Principal swapped to slisBNB. Limit: 0.1 - 1.0 BNB.</span>
                </div>
                <div class="wish-paper">
                    <div style="margin-bottom:10px; font-size:14px; opacity:0.8;">ä¿¡å¾’ (User)ï¼š<span id="userAddrShort">...</span></div>
                    <input type="text" id="wish1" class="wish-input" placeholder="é¡˜æœ›ä¸€ (Wish 1)" maxlength="50">
                    <input type="text" id="wish2" class="wish-input" placeholder="é¡˜æœ›äºŒ (Wish 2)" maxlength="50">
                    <input type="text" id="wish3" class="wish-input" placeholder="é¡˜æœ›ä¸‰ (Wish 3)" maxlength="50">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="color:#aaa; font-size:14px;">é¦™æ²¹éŒ¢ (Deposit BNB)</label><br>
                    <input type="number" id="depositAmount" value="0.1" step="0.01" min="0.1" max="1.0" 
                        style="padding: 12px; margin-top:5px; border-radius: 8px; border:2px solid var(--primary-gold); background:#300; color:var(--primary-gold); text-align:center; width:150px; font-size:20px; font-weight:bold;">
                    <p style="color:#888; font-size:12px; margin-top:5px;">( Limit: 0.1 ~ 1.0 BNB )</p>
                </div>
                <button id="lightBtn" class="btn" onclick="lightLamp()">âœ¨ èª å¿ƒé»ç‡ˆ<br><span style="font-size:14px;">Light Up the Lamp</span></button>
            </div>
        </div>

        <div id="myLampSection" class="hidden">
            <div class="dashboard-card" style="box-shadow: 0 0 20px var(--primary-gold);">
                <h2 style="margin:0 0 15px 0; color:var(--primary-gold);">ğŸ® æ‚¨çš„å…‰æ˜ç‡ˆå·²å®‰åº§<br><span style="font-size:14px; color:#aaa;">Lamp Activated</span></h2>
                <div style="text-align: left; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">
                    <ul id="myWishesList" style="list-style:none; padding:0; color:#ffb3b3;"></ul>
                    <div style="border-top:1px dashed #555; margin-top:10px; padding-top:10px;">
                        <div>ğŸ’° æŠ•å…¥æœ¬é‡‘ (Principal)ï¼š<span id="myPrincipal" class="status-value">0</span> BNB</div>
                        <div>ğŸ“… åœ“æ»¿æ—¥ (Unlock Date)ï¼š<br><span id="unlockDate" style="color:#fff;">---</span></div>
                    </div>
                </div>
                <div id="countdownSection" class="countdown">è¼‰å…¥ä¸­... Loading...</div>
                <div style="margin-top:20px;">
                    <button id="redeemBtn" class="btn hidden" onclick="redeemLamp()">ğŸ‰ åŠŸå¾·åœ“æ»¿ï¼Œé ˜å–æœ¬é‡‘+åˆ©æ½¤<br><span style="font-size:14px;">Redeem Principal + Profit</span></button>
                    <div id="earlyExitSection">
                        <div style="border:1px solid #ff5252; padding:15px; border-radius:10px; background:rgba(183,28,28,0.3);">
                            <h4 style="margin:0 0 10px 0; color:#ff5252;">âš ï¸ ææ—©ç†„ç‡ˆ (Emergency Exit)</h4>
                            <p style="color:#ff5252; font-size:13px;">è­¦å‘Šï¼šææ—©é›¢å ´åƒ…é€€é‚„æœ¬é‡‘ (æ‰£ 5% æ‰‹çºŒè²»)ï¼Œä¸ç™¼æ”¾åˆ©æ½¤ã€‚<br><span class="en-text" style="color:#ffaaaa;">Warning: Early exit returns principal only (minus 5% fee). No profit.</span></p>
                            <button id="requestExitBtn" class="btn btn-danger" onclick="requestEarlyExit()">ç”³è«‹ç†„ç‡ˆ (é–‹å§‹ 7 å¤©å†·å»)<br><span style="font-size:14px;">Request Exit (7 Days Cooldown)</span></button>
                            <div id="cooldownTimerDiv" class="hidden">
                                <p style="color:#FFA500;">â³ å†·å»ä¸­ Cooldown Active...</p>
                                <div id="cooldownTimer" class="countdown" style="font-size:16px;"></div>
                                <button id="executeExitBtn" class="btn btn-danger hidden" onclick="executeEarlyExit()">ç¢ºèªç†„ç‡ˆ<br><span style="font-size:14px;">Confirm Exit</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // âœ… æ‚¨æä¾›çš„ V8 æœ€æ–°åœ°å€
    const CONTRACT_ADDRESS = "0x0fE20821301E6a8319015a1D26D7a545630235D9"; 

    // âœ… V8 ABI
    const ABI = [
        "function lightLamp(string[3] _wishes) external payable",
        "function redeemLamp() external",
        "function requestEarlyExit() external",
        "function executeEarlyExit() external",
        "function getLampData(address _user) view returns (tuple(string[3] wishes, uint256 principal, uint256 shares, uint256 unlockTime, uint256 cooldownEndTime, bool exists))",
        "function getBatchLamps(uint256 count) view returns (tuple(address user, string[3] wishes)[])",
        "function getGlobalStats() view returns (uint256, uint256, uint256)"
    ];

    let provider, signer, contract;
    let userAddress;
    let countdownInterval;

    const RPC_URLS = [
        "https://bsc-dataseed1.binance.org/",
        "https://rpc.ankr.com/bsc",
        "https://bsc-dataseed2.binance.org/"
    ];

    // ğŸ”¥ é™¤éŒ¯è¦–çª—é‚è¼¯
    function showError(error) {
        const modal = document.getElementById("errorModal");
        const textArea = document.getElementById("errorText");
        
        let errorMsg = "Time: " + new Date().toLocaleString() + "\n";
        
        if (typeof error === 'object') {
            if (error.reason) errorMsg += `Reason: ${error.reason}\n`;
            if (error.code) errorMsg += `Code: ${error.code}\n`;
            if (error.message) errorMsg += `Message: ${error.message}\n`;
            if (error.data) {
                try {
                    errorMsg += `Data: ${JSON.stringify(error.data)}\n`;
                } catch(e) {
                    errorMsg += `Data: ${error.data}\n`;
                }
            }
        } else {
            errorMsg += String(error);
        }

        errorMsg += "\n\n(è«‹æˆªåœ–æˆ–è¤‡è£½æ­¤å…§å®¹çµ¦é–‹ç™¼è€…)";
        
        textArea.value = errorMsg;
        modal.style.display = "flex";
        console.error("æ•æ‰åˆ°éŒ¯èª¤:", error);
    }

    function closeError() {
        document.getElementById("errorModal").style.display = "none";
    }

    function copyError() {
        const textArea = document.getElementById("errorText");
        textArea.select();
        document.execCommand("copy");
        alert("å·²è¤‡è£½éŒ¯èª¤å…§å®¹ï¼Copied!");
    }

    window.onload = function() {
        if (typeof ethers === 'undefined') {
            document.getElementById("marqueeText").innerText = "âš ï¸ Ethers.js Load Failed";
            return;
        }
        initData();
    };

    async function initData() {
        const marqueeDiv = document.getElementById("marqueeText");
        
        for (let url of RPC_URLS) {
            try {
                const readProvider = new ethers.providers.JsonRpcProvider(url);
                const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);
                
                const code = await readProvider.getCode(CONTRACT_ADDRESS);
                if (code === "0x") throw new Error("Contract not deployed");

                const [lamps, stats] = await Promise.all([
                    readContract.getBatchLamps(150),
                    readContract.getGlobalStats()
                ]);

                // V8 çµ±è¨ˆ
                const totalDeposited = stats[0];
                const totalUsers = stats[1];
                const totalProfit = stats[2];

                document.getElementById("totalBNB").innerText = parseFloat(ethers.utils.formatEther(totalDeposited)).toFixed(2) + " BNB";
                document.getElementById("totalUsers").innerText = totalUsers.toString();
                document.getElementById("totalProfit").innerText = parseFloat(ethers.utils.formatEther(totalProfit)).toFixed(4) + " BNB";

                if (lamps.length === 0) {
                    marqueeDiv.innerHTML = "âœ¨ 2026 å¹£åœˆå…‰æ˜ç‡ˆè™›ä½ä»¥å¾…ï¼Œç¾åœ¨é»ç‡ˆæ‚¨å°±æ˜¯ç¬¬ä¸€ä½ï¼ Be the first one! âœ¨";
                    return;
                }
                
                let html = "";
                let allWishes = [];
                for (let i = 0; i < 3; i++) {
                    lamps.forEach(lamp => {
                        const addr = lamp.user.substring(0,6) + ".." + lamp.user.substring(38);
                        const wish = lamp.wishes[i];
                        if (wish && wish.trim() !== "") allWishes.push({ addr, wish });
                    });
                }
                allWishes.forEach(item => { html += `<span class="marquee-item"><span class="marquee-addr">${item.addr}</span> ${item.wish}</span>`; });
                marqueeDiv.innerHTML = html + html;
                return; 

            } catch (e) {
                console.warn("RPC Retry:", e.message);
                continue;
            }
        }
        marqueeDiv.innerHTML = "âœ¨ Welcome to Crypto Beacon Light âœ¨";
    }

    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') { alert("Please install MetaMask (è«‹å®‰è£éŒ¢åŒ…)"); return; }
        
        const btn = document.getElementById("connectBtn");
        btn.innerHTML = "é€£ç·šä¸­...<br><span style='font-size:14px'>Connecting...</span>";
        btn.disabled = true;

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            const network = await provider.getNetwork();
            if (network.chainId !== 56) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }]});
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch(e) { throw new Error("Please switch to BSC Mainnet (è«‹åˆ‡æ›è‡³ BSC ä¸»ç¶²)"); }
            }

            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById("connectSection").classList.add("hidden");
            document.getElementById("loadingMsg").style.display = "block";
            document.getElementById("userAddrShort").innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
            
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            await checkLampStatus();

        } catch (e) { 
            showError(e); 
            btn.innerHTML = "ğŸ¦Š é€£çµéŒ¢åŒ…<br><span style='font-size:14px'>Connect Wallet</span>";
            btn.disabled = false;
            document.getElementById("connectSection").classList.remove("hidden");
            document.getElementById("loadingMsg").style.display = "none";
        }
    }

    async function checkLampStatus() {
        try {
            const lamp = await contract.getLampData(userAddress);
            document.getElementById("loadingMsg").style.display = "none";

            if (lamp.exists && lamp.shares.gt(0)) {
                document.getElementById("myLampSection").classList.remove("hidden");
                renderMyLamp(lamp);
            } else {
                document.getElementById("lightLampSection").classList.remove("hidden");
            }
        } catch (e) { 
            if (e.code === 'CALL_EXCEPTION') {
                showError({
                    message: "Contract Read Failed (è®€å–å¤±æ•—)",
                    reason: "1. Wrong Network 2. Wrong ABI 3. Node Error",
                    data: e
                });
            } else {
                showError(e);
            }
            
            document.getElementById("connectSection").classList.remove("hidden");
            document.getElementById("connectBtn").innerHTML = "ğŸ¦Š é€£çµéŒ¢åŒ…<br><span style='font-size:14px'>Connect Wallet</span>";
            document.getElementById("connectBtn").disabled = false;
            document.getElementById("loadingMsg").style.display = "none";
        }
    }

    function renderMyLamp(lamp) {
        const wishList = document.getElementById("myWishesList");
        wishList.innerHTML = "";
        lamp[0].forEach(w => { if(w) wishList.innerHTML += `<li>âœ¨ ${w}</li>`; });
        
        document.getElementById("myPrincipal").innerText = parseFloat(ethers.utils.formatEther(lamp[1])).toFixed(4);
        
        const unlockTime = lamp[3].toNumber();
        const now = Math.floor(Date.now() / 1000);
        document.getElementById("unlockDate").innerText = new Date(unlockTime*1000).toLocaleString();

        if(countdownInterval) clearInterval(countdownInterval);

        if (now >= unlockTime) {
            document.getElementById("countdownSection").innerText = "âœ¨ åŠŸå¾·åœ“æ»¿ï¼ Completed!";
            document.getElementById("redeemBtn").classList.remove("hidden");
            document.getElementById("earlyExitSection").classList.add("hidden");
        } else {
            const cooldownEnd = lamp[4].toNumber();
            if (cooldownEnd > 0) {
                document.getElementById("requestExitBtn").classList.add("hidden");
                document.getElementById("cooldownTimerDiv").classList.remove("hidden");
                if (now >= cooldownEnd) {
                    document.getElementById("cooldownTimer").innerText = "å†·å»çµæŸ Cooldown Ended";
                    document.getElementById("executeExitBtn").classList.remove("hidden");
                } else {
                    startCountdown(cooldownEnd, "cooldownTimer", "å†·å»çµæŸ Cooldown Ended", () => checkLampStatus());
                }
            } else {
                startCountdown(unlockTime, "countdownSection", "å³å°‡åŠŸå¾·åœ“æ»¿ Almost Done", () => checkLampStatus());
            }
        }
    }

    async function lightLamp() {
        const w1 = document.getElementById("wish1").value;
        const w2 = document.getElementById("wish2").value;
        const w3 = document.getElementById("wish3").value;
        const amt = document.getElementById("depositAmount").value;
        
        const amtFloat = parseFloat(amt);
        if (amtFloat < 0.1 || amtFloat > 1.0) { alert("â›”ï¸ Limit: 0.1 ~ 1.0 BNB"); return; }
        
        if ((w1+w2+w3).match(/\d{9,}/)) { if(!confirm("âš ï¸ åµæ¸¬åˆ°é•·æ•¸å­—ã€‚ç¢ºå®šè¦å…¬é–‹ä¸Šéˆå—ï¼Ÿ\nContains long numbers. Proceed?")) return; }

        try {
            const gasLimit = await contract.estimateGas.lightLamp([w1, w2, w3], { value: ethers.utils.parseEther(amt) });
            
            const tx = await contract.lightLamp([w1, w2, w3], { 
                value: ethers.utils.parseEther(amt),
                gasLimit: gasLimit.mul(120).div(100)
            });
            
            alert("ç™¼é€æˆåŠŸï¼Œç­‰å¾…ä¸Šéˆ... Transaction Sent...");
            await tx.wait();
            alert("ğŸ‰ é»ç‡ˆæˆåŠŸï¼ Success!");
            location.reload(); 
        } catch(e) { 
            showError(e);
        }
    }

    async function redeemLamp() { try { const tx = await contract.redeemLamp(); await tx.wait(); alert("é ˜å–æˆåŠŸ Success!"); location.reload(); } catch(e){showError(e);} }
    async function requestEarlyExit() { if(!confirm("ç¢ºå®šææ—©ç†„ç‡ˆï¼Ÿ\nAre you sure to exit early?")) return; try { const tx = await contract.requestEarlyExit(); await tx.wait(); alert("å·²ç”³è«‹å†·å» Cooldown Started"); location.reload(); } catch(e){showError(e);} }
    async function executeEarlyExit() { try { const tx = await contract.executeEarlyExit(); await tx.wait(); alert("å·²ç†„ç‡ˆ Exited"); location.reload(); } catch(e){showError(e);} }

    function startCountdown(target, id, msg, cb) {
        const el = document.getElementById(id);
        countdownInterval = setInterval(() => {
            const now = Math.floor(Date.now()/1000);
            const diff = target - now;
            if(diff <= 0) { clearInterval(countdownInterval); el.innerText = msg; if(cb) cb(); }
            else {
                const d = Math.floor(diff/86400);
                const h = Math.floor((diff%86400)/3600);
                const m = Math.floor((diff%3600)/60);
                const s = diff%60;
                el.innerText = `é‚„æœ‰ ${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’\n${d}d ${h}h ${m}m ${s}s left`;
            }
        }, 1000);
    }
</script>
</body>
</html>
