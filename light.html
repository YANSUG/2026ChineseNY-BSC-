<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ® 2026 å¹£åœˆå…‰æ˜ç‡ˆ | éˆä¸Šç¥ˆç¦ HODL è³ºå¤§éŒ¢</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #FFD700;
            --primary-red: #D90429;
            --dark-bg: #1a0505;
            --neon-glow: 0 0 15px var(--primary-gold), 0 0 30px var(--primary-red);
        }
        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 50% 30%, #4a0000 0%, #1a0505 70%);
            color: var(--primary-gold);
            font-family: 'Noto Serif TC', 'Microsoft JhengHei', serif;
            text-align: center;
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* è·‘é¦¬ç‡ˆ */
        .marquee-container {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid var(--primary-gold);
            width: 100%; height: 40px;
            display: flex; align-items: center;
            overflow: hidden; position: relative; z-index: 100;
        }
        .marquee-content {
            display: inline-block; white-space: nowrap;
            animation: scroll 60s linear infinite;
            color: #fff; font-size: 15px;
        }
        .marquee-item { margin-right: 50px; display: inline-flex; align-items: center; }
        .marquee-addr { color: var(--primary-gold); margin-right: 8px; font-family: monospace; background: #300; padding: 2px 6px; border-radius: 4px; border: 1px solid #500; }
        @keyframes scroll { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        .container { max-width: 500px; margin: 20px auto; padding: 0 20px 80px 20px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 8px #000; margin-top: 20px; }
        .subtitle { color: #ffb3b3; margin-bottom: 30px; font-size: 1.1rem; }

        .dashboard-card {
            background: rgba(60, 10, 10, 0.9);
            border: 3px solid var(--primary-gold);
            border-radius: 15px;
            padding: 25px; margin-bottom: 25px;
            box-shadow: var(--neon-glow);
            position: relative;
        }

        .wish-paper { background: #fffce0; border: 2px solid #b71c1c; padding: 20px 15px; color: #b71c1c; border-radius: 5px; margin-bottom: 20px; position: relative; }
        .wish-input { width: 90%; border: none; border-bottom: 2px dashed #b71c1c; background: transparent; color: #b71c1c; font-size: 18px; padding: 8px; margin: 8px 0; text-align: center; outline: none; font-weight: bold; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            background: linear-gradient(180deg, var(--primary-gold), #FFA500);
            color: #500000; border: none; padding: 15px 30px;
            font-size: 20px; font-weight: bold; border-radius: 50px;
            cursor: pointer; width: 100%; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: block; 
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn:disabled { filter: grayscale(1); cursor: not-allowed; transform: none; opacity: 0.7; }
        .btn-danger { background: linear-gradient(180deg, #ff5252, #b71c1c); color: white; }

        .privacy-alert { font-size: 13px; color: #ffcccc; background: rgba(183, 28, 28, 0.6); padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ff5252; text-align: left; }
        .status-value { font-size: 18px; font-weight: bold; color: #00FF00; }
        .countdown { font-family: monospace; font-size: 20px; color: #FFA500; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin: 15px 0; }
        
        .hidden { display: none !important; }
        
        /* è¼‰å…¥ä¸­è¨Šæ¯ */
        #loadingMsg { color: #FFA500; font-size: 18px; margin: 20px 0; display: none; }
    </style>
</head>
<body>

    <div class="marquee-container">
        <div class="marquee-content" id="marqueeText">
            âœ¨ è¼‰å…¥éˆä¸Šç¥ˆç¦æ•¸æ“šä¸­... (è‹¥ä¹…å€™è«‹æª¢æŸ¥ç¶²è·¯) âœ¨
        </div>
    </div>

    <div class="container">
        <h1>ğŸ® 2026 å¹£åœˆå…‰æ˜ç‡ˆ ğŸ®</h1>
        <div class="subtitle">é»ç‡ˆç¥ˆç¦ HODL ä¸€å¹´ï¼Œè²¡ç¥çˆºå¹«ä½ éŒ¢æ»¾éŒ¢</div>

        <div id="connectSection">
            <button id="connectBtn" class="btn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ… (Connect)</button>
            <p style="color:#aaa; font-size:13px; margin-top:10px;">è«‹ä½¿ç”¨ BSC ä¸»ç¶² â€¢ 0.01 BNB é»ç‡ˆ</p>
        </div>

        <div id="loadingMsg">â³ æ­£åœ¨è®€å–å€å¡Šéˆæ•¸æ“š...</div>

        <div id="lightLampSection" class="hidden">
            <div class="dashboard-card">
                <h3 style="margin-top:0; color:var(--primary-gold);">ğŸ™ å¡«å¯«ç¥ˆç¦ç–æ–‡</h3>
                <div class="privacy-alert">
                    <strong>âš ï¸ éš±ç§è­¦å‘Šï¼š</strong><br>
                    å€å¡Šéˆæ•¸æ“šå…¨å…¬é–‹ï¼Œè«‹å‹¿è¼¸å…¥çœŸå¯¦å§“åã€é›»è©±æˆ–ç§é‘°ã€‚<br>
                    å»ºè­°åªå¯«é¡˜æœ› (å¦‚ï¼šBTC ç ´åè¬)ã€‚
                </div>
                <div class="wish-paper">
                    <div style="margin-bottom:10px; font-size:14px; opacity:0.8;">ä¿¡å¾’ï¼š<span id="userAddrShort">...</span></div>
                    <input type="text" id="wish1" class="wish-input" placeholder="é¡˜æœ›ä¸€ (ä¾‹: è²¡å¯Œè‡ªç”±)" maxlength="50">
                    <input type="text" id="wish2" class="wish-input" placeholder="é¡˜æœ›äºŒ (ä¾‹: å®¶äººå¥åº·)" maxlength="50">
                    <input type="text" id="wish3" class="wish-input" placeholder="é¡˜æœ›ä¸‰ (ä¾‹: åˆç´„å®‰å…¨)" maxlength="50">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="color:#aaa; font-size:14px;">é¦™æ²¹éŒ¢ (BNB)</label><br>
                    <input type="number" id="depositAmount" value="0.01" step="0.01" min="0.01" 
                        style="padding: 12px; margin-top:5px; border-radius: 8px; border:2px solid var(--primary-gold); background:#300; color:var(--primary-gold); text-align:center; width:150px; font-size:20px; font-weight:bold;">
                </div>
                <button id="lightBtn" class="btn" onclick="lightLamp()">âœ¨ èª å¿ƒé»ç‡ˆ (Light Up)</button>
            </div>
        </div>

        <div id="myLampSection" class="hidden">
            <div class="dashboard-card" style="box-shadow: 0 0 20px var(--primary-gold);">
                <h2 style="margin:0 0 15px 0; color:var(--primary-gold);">ğŸ® æ‚¨çš„å…‰æ˜ç‡ˆå·²å®‰åº§</h2>
                <div style="text-align: left; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">
                    <ul id="myWishesList" style="list-style:none; padding:0; color:#ffb3b3;"></ul>
                    <div style="border-top:1px dashed #555; margin-top:10px; padding-top:10px;">
                        <div>ğŸ’° é¦™æ²¹éŒ¢ï¼š<span id="myPrincipal" class="status-value">0</span> BNB</div>
                        <div>ğŸ“… åœ“æ»¿æ—¥ï¼š<span id="unlockDate" style="color:#fff;">---</span></div>
                    </div>
                </div>
                <div id="countdownSection" class="countdown">è¼‰å…¥ä¸­...</div>
                <div style="margin-top:20px;">
                    <button id="redeemBtn" class="btn hidden" onclick="redeemLamp()">ğŸ‰ åŠŸå¾·åœ“æ»¿ï¼Œé ˜å–ç¦å ±</button>
                    <div id="earlyExitSection">
                        <div style="border:1px solid #ff5252; padding:15px; border-radius:10px; background:rgba(183,28,28,0.3);">
                            <h4 style="margin:0 0 10px 0; color:#ff5252;">âš ï¸ ææ—©ç†„ç‡ˆ (ç ´è²¡æ¶ˆç½)</h4>
                            <p style="color:#ff5252; font-size:13px;">è­¦å‘Šï¼šç¾åœ¨ç†„ç‡ˆåƒ…èƒ½å–å›æœ¬é‡‘ï¼Œåˆ©æ½¤å°‡å……å…¬è¿´å‘ç¤¾ç¾¤ã€‚</p>
                            <button id="requestExitBtn" class="btn btn-danger" onclick="requestEarlyExit()">ç”³è«‹ç†„ç‡ˆ (é–‹å§‹ 7 å¤©å†·å»)</button>
                            <div id="cooldownTimerDiv" class="hidden">
                                <p style="color:#FFA500;">â³ å†·å»ä¸­...</p>
                                <div id="cooldownTimer" class="countdown" style="font-size:16px;"></div>
                                <button id="executeExitBtn" class="btn btn-danger hidden" onclick="executeEarlyExit()">ç¢ºèªç†„ç‡ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const CONTRACT_ADDRESS = "0x0676b83f895fF8003c3149B1Dcb6c3D31B41ac6A"; 
    const ABI = [
        "function lightLamp(string[3] _wishes) external payable",
        "function redeemLamp() external",
        "function requestEarlyExit() external",
        "function executeEarlyExit() external",
        "function userLamps(address) view returns (string[3] wishes, uint256 principal, uint256 shares, uint256 unlockTime, uint256 cooldownEndTime, bool exists)",
        "function getBatchLamps(uint256 count) view returns (tuple(address user, string[3] wishes)[])"
    ];

    let provider, signer, contract;
    let userAddress;
    let countdownInterval;

    window.onload = function() {
        if (typeof ethers === 'undefined') {
            document.getElementById("marqueeText").innerText = "âš ï¸ Ethers.js è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥";
            return;
        }
        initRealMarquee();
    };

    // 1. è·‘é¦¬ç‡ˆ
    async function initRealMarquee() {
        const marqueeDiv = document.getElementById("marqueeText");
        const readProvider = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
        const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);

        try {
            const lamps = await readContract.getBatchLamps(150);
            if (lamps.length === 0) {
                marqueeDiv.innerHTML = "âœ¨ 2026 å¹£åœˆå…‰æ˜ç‡ˆè™›ä½ä»¥å¾…ï¼Œç¾åœ¨é»ç‡ˆæ‚¨å°±æ˜¯ç¬¬ä¸€ä½ï¼ âœ¨";
                return;
            }
            let html = "";
            let allWishes = [];
            for (let i = 0; i < 3; i++) {
                lamps.forEach(lamp => {
                    const addr = lamp.user.substring(0,6) + ".." + lamp.user.substring(38);
                    const wish = lamp.wishes[i];
                    if (wish && wish.trim() !== "") allWishes.push({ addr, wish });
                });
            }
            allWishes.forEach(item => { html += `<span class="marquee-item"><span class="marquee-addr">${item.addr}</span> ${item.wish}</span>`; });
            marqueeDiv.innerHTML = html + html;
        } catch (e) {
            console.error("è·‘é¦¬ç‡ˆå¤±æ•—", e);
            marqueeDiv.innerHTML = "âœ¨ æ­¡è¿ä¾†åˆ°å¹£åœˆå…‰æ˜ç‡ˆ (è·‘é¦¬ç‡ˆè®€å–ä¸­...) âœ¨";
        }
    }

    // 2. é€£æ¥éŒ¢åŒ… (å®‰å…¨ç‰ˆ)
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') { alert("è«‹å®‰è£ MetaMask"); return; }
        
        const btn = document.getElementById("connectBtn");
        btn.innerText = "é€£ç·šä¸­...";
        btn.disabled = true;

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            const network = await provider.getNetwork();
            if (network.chainId !== 56) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }]});
                    provider = new ethers.providers.Web3Provider(window.ethereum); // é‡æ–°å»ºç«‹ provider
                } catch(e) { throw new Error("è«‹åˆ‡æ›åˆ° BSC ä¸»ç¶² (Chain ID 56)"); }
            }

            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            // UI æ›´æ–°ï¼šå…ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œä¸è¦æ€¥è‘—éš±è—
            document.getElementById("connectSection").classList.add("hidden");
            document.getElementById("loadingMsg").style.display = "block";
            document.getElementById("userAddrShort").innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
            
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            // è®€å–ç‹€æ…‹
            await checkLampStatus();

        } catch (e) { 
            console.error(e); 
            alert("é€£æ¥å¤±æ•—: " + e.message); 
            // å¤±æ•—æ™‚æ¢å¾©æŒ‰éˆ•
            btn.innerText = "ğŸ¦Š é€£çµéŒ¢åŒ… (Connect)";
            btn.disabled = false;
            document.getElementById("connectSection").classList.remove("hidden");
            document.getElementById("loadingMsg").style.display = "none";
        }
    }

    // 3. ç‹€æ…‹æª¢æŸ¥
    async function checkLampStatus() {
        try {
            console.log("æ­£åœ¨è®€å–åˆç´„...", userAddress);
            const lamp = await contract.userLamps(userAddress);
            console.log("åˆç´„å›å‚³:", lamp);

            // æˆåŠŸè®€å–å¾Œï¼Œéš±è—è¼‰å…¥è¨Šæ¯
            document.getElementById("loadingMsg").style.display = "none";

            if (lamp.exists && lamp.shares.gt(0)) {
                document.getElementById("myLampSection").classList.remove("hidden");
                renderMyLamp(lamp);
            } else {
                document.getElementById("lightLampSection").classList.remove("hidden");
            }
        } catch (e) { 
            console.error("ç‹€æ…‹è®€å–éŒ¯èª¤", e);
            document.getElementById("loadingMsg").innerHTML = "âš ï¸ è®€å–åˆç´„å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†æˆ–æª¢æŸ¥ç¶²è·¯";
            // å½ˆå‡ºéŒ¯èª¤è®“ä½ çŸ¥é“åŸå› 
            alert("è®€å–åˆç´„æ•¸æ“šå¤±æ•—ï¼š" + (e.reason || e.message));
            // æ¢å¾©é¡¯ç¤ºé€£æ¥æŒ‰éˆ•
            document.getElementById("connectSection").classList.remove("hidden");
            document.getElementById("loadingMsg").style.display = "none";
        }
    }

    function renderMyLamp(lamp) {
        const wishList = document.getElementById("myWishesList");
        wishList.innerHTML = "";
        lamp.wishes.forEach(w => { if(w) wishList.innerHTML += `<li>âœ¨ ${w}</li>`; });
        document.getElementById("myPrincipal").innerText = parseFloat(ethers.utils.formatEther(lamp.principal)).toFixed(4);
        
        const unlockTime = lamp.unlockTime.toNumber();
        const now = Math.floor(Date.now() / 1000);
        document.getElementById("unlockDate").innerText = new Date(unlockTime*1000).toLocaleString();

        if(countdownInterval) clearInterval(countdownInterval);

        if (now >= unlockTime) {
            document.getElementById("countdownSection").innerText = "âœ¨ åŠŸå¾·åœ“æ»¿ï¼";
            document.getElementById("redeemBtn").classList.remove("hidden");
            document.getElementById("earlyExitSection").classList.add("hidden");
        } else {
            const cooldownEnd = lamp.cooldownEndTime.toNumber();
            if (cooldownEnd > 0) {
                document.getElementById("requestExitBtn").classList.add("hidden");
                document.getElementById("cooldownTimerDiv").classList.remove("hidden");
                if (now >= cooldownEnd) {
                    document.getElementById("cooldownTimer").innerText = "å†·å»çµæŸ";
                    document.getElementById("executeExitBtn").classList.remove("hidden");
                } else {
                    startCountdown(cooldownEnd, "cooldownTimer", "å†·å»çµæŸ", () => checkLampStatus());
                }
            } else {
                startCountdown(unlockTime, "countdownSection", "å³å°‡åŠŸå¾·åœ“æ»¿", () => checkLampStatus());
            }
        }
    }

    // äº¤æ˜“åŠŸèƒ½
    async function lightLamp() {
        const w1 = document.getElementById("wish1").value;
        const w2 = document.getElementById("wish2").value;
        const w3 = document.getElementById("wish3").value;
        const amt = document.getElementById("depositAmount").value;
        if(parseFloat(amt) < 0.01) { alert("è‡³å°‘ 0.01 BNB"); return; }
        if ((w1+w2+w3).match(/\d{9,}/)) { if(!confirm("âš ï¸ åµæ¸¬åˆ°é•·æ•¸å­—ã€‚ç¢ºå®šè¦å…¬é–‹ä¸Šéˆå—ï¼Ÿ")) return; }

        try {
            const tx = await contract.lightLamp([w1, w2, w3], { value: ethers.utils.parseEther(amt) });
            alert("ç™¼é€æˆåŠŸï¼Œç­‰å¾…ä¸Šéˆ...");
            await tx.wait();
            alert("ğŸ‰ é»ç‡ˆæˆåŠŸï¼");
            location.reload(); // é‡æ–°æ•´ç†æœ€ä¿éšª
        } catch(e) { alert("å¤±æ•—: " + (e.data?.message || e.message)); }
    }

    // å…¶ä»–åŠŸèƒ½ä¿æŒä¸è®Š
    async function redeemLamp() { try { const tx = await contract.redeemLamp(); await tx.wait(); alert("é ˜å–æˆåŠŸ"); location.reload(); } catch(e){alert(e.message);} }
    async function requestEarlyExit() { if(!confirm("ç¢ºå®šææ—©ç†„ç‡ˆï¼Ÿ")) return; try { const tx = await contract.requestEarlyExit(); await tx.wait(); alert("å·²ç”³è«‹å†·å»"); location.reload(); } catch(e){alert(e.message);} }
    async function executeEarlyExit() { try { const tx = await contract.executeEarlyExit(); await tx.wait(); alert("å·²ç†„ç‡ˆ"); location.reload(); } catch(e){alert(e.message);} }

    function startCountdown(target, id, msg, cb) {
        const el = document.getElementById(id);
        countdownInterval = setInterval(() => {
            const now = Math.floor(Date.now()/1000);
            const diff = target - now;
            if(diff <= 0) { clearInterval(countdownInterval); el.innerText = msg; if(cb) cb(); }
            else {
                const d = Math.floor(diff/86400);
                const h = Math.floor((diff%86400)/3600);
                const m = Math.floor((diff%3600)/60);
                const s = diff%60;
                el.innerText = `é‚„æœ‰ ${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
            }
        }, 1000);
    }
</script>
</body>
</html>
